{% extends "base.html" %}

{% block title %}Services - System Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cogs me-2"></i>Running Services
            <small class="text-muted">Monitor system processes and services</small>
        </h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="service-search" placeholder="Search services...">
        </div>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-outline-primary" onclick="refreshServices()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Services List
            <span class="badge bg-primary ms-2" id="service-count">0</span>
        </h5>
    </div>
    <div class="card-body">
        <div id="services-container">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Loading services...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allServices = [];

function refreshServices() {
    showLoading('services-container');
    
    fetch('/api/services')
        .then(response => response.json())
        .then(services => {
            allServices = services;
            displayServices(services);
            document.getElementById('service-count').textContent = services.length;
        })
        .catch(error => {
            console.error('Error fetching services:', error);
            showError('services-container', 'Failed to load services data');
        });
}

function displayServices(services) {
    const container = document.getElementById('services-container');
    
    if (!services || services.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No services found</p>';
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th onclick="sortServices('name')" style="cursor: pointer;">
                            Service Name <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortServices('pid')" style="cursor: pointer;">
                            PID <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortServices('status')" style="cursor: pointer;">
                            Status <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortServices('cpu_percent')" style="cursor: pointer;">
                            CPU % <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortServices('memory_percent')" style="cursor: pointer;">
                            Memory % <i class="fas fa-sort"></i>
                        </th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    services.forEach(service => {
        const statusClass = service.status === 'running' ? 'success' : 'warning';
        html += `
            <tr>
                <td>
                    <strong>${service.name}</strong>
                </td>
                <td>
                    <code>${service.pid}</code>
                </td>
                <td>
                    <span class="badge bg-${statusClass}">${service.status}</span>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${service.cpu_percent > 50 ? 'bg-danger' : service.cpu_percent > 25 ? 'bg-warning' : 'bg-success'}" 
                             style="width: ${Math.min(service.cpu_percent, 100)}%">
                            ${formatPercentage(service.cpu_percent)}
                        </div>
                    </div>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${service.memory_percent > 50 ? 'bg-danger' : service.memory_percent > 25 ? 'bg-warning' : 'bg-success'}" 
                             style="width: ${Math.min(service.memory_percent, 100)}%">
                            ${formatPercentage(service.memory_percent)}
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function sortServices(column) {
    allServices.sort((a, b) => {
        if (column === 'name') {
            return a.name.localeCompare(b.name);
        } else if (column === 'pid') {
            return a.pid - b.pid;
        } else if (column === 'status') {
            return a.status.localeCompare(b.status);
        } else {
            return b[column] - a[column];
        }
    });
    displayServices(allServices);
}

function filterServices() {
    const searchTerm = document.getElementById('service-search').value.toLowerCase();
    const filteredServices = allServices.filter(service => 
        service.name.toLowerCase().includes(searchTerm) ||
        service.pid.toString().includes(searchTerm) ||
        service.status.toLowerCase().includes(searchTerm)
    );
    displayServices(filteredServices);
    document.getElementById('service-count').textContent = filteredServices.length;
}

// Event listeners
document.getElementById('service-search').addEventListener('input', filterServices);

// Initial load
refreshServices();
</script>
{% endblock %}
