{% extends "base.html" %}

{% block title %}Dashboard - System Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>System Monitor Dashboard
            <small class="text-muted">Real-time system monitoring</small>
        </h1>
    </div>
</div>

<!-- System Overview Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card metric-card card-hover">
            <div class="card-body text-center">
                <i class="fas fa-microchip fa-2x mb-2"></i>
                <h5>CPU Usage</h5>
                <h3 id="cpu-usage">--</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card card-hover">
            <div class="card-body text-center">
                <i class="fas fa-memory fa-2x mb-2"></i>
                <h5>Memory Usage</h5>
                <h3 id="memory-usage">--</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card card-hover">
            <div class="card-body text-center">
                <i class="fas fa-hdd fa-2x mb-2"></i>
                <h5>Disk Usage</h5>
                <h3 id="disk-usage">--</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card card-hover">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h5>Uptime</h5>
                <h6 id="uptime">--</h6>
            </div>
        </div>
    </div>
</div>

<!-- Database Status Cards -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card card-hover">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2"></i>MySQL Status
                </h5>
            </div>
            <div class="card-body">
                <div id="mysql-status">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card card-hover">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2"></i>PostgreSQL Status
                </h5>
            </div>
            <div class="card-body">
                <div id="postgresql-status">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Top Running Services
                </h5>
            </div>
            <div class="card-body">
                <div id="top-services">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-network-wired me-2"></i>Active Ports
                </h5>
            </div>
            <div class="card-body">
                <div id="active-ports">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Last Updated -->
<div class="row mt-3">
    <div class="col-12">
        <small class="text-muted">
            <i class="fas fa-clock me-1"></i>Last updated: <span id="last-updated">--</span>
        </small>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshData() {
    fetch('/api/monitoring-data')
        .then(response => response.json())
        .then(data => {
            updateSystemInfo(data.system_info);
            updateDatabaseStatus(data.mysql_status, data.postgresql_status);
            updateTopServices(data.running_services);
            updateActivePorts(data.active_ports);
            updateLastUpdated(data.timestamp);
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            showError('cpu-usage', 'Failed to load system data');
        });
}

function updateSystemInfo(systemInfo) {
    if (systemInfo) {
        document.getElementById('cpu-usage').textContent = formatPercentage(systemInfo.cpu_percent);
        document.getElementById('memory-usage').textContent = formatPercentage(systemInfo.memory_percent);
        document.getElementById('disk-usage').textContent = formatPercentage(systemInfo.disk_usage);
        document.getElementById('uptime').textContent = systemInfo.uptime || 'Unknown';
    }
}

function updateDatabaseStatus(mysqlStatus, postgresStatus) {
    // MySQL Status
    const mysqlDiv = document.getElementById('mysql-status');
    if (mysqlStatus) {
        const statusClass = mysqlStatus.running ? 'status-running' : 'status-stopped';
        const icon = mysqlStatus.running ? 'fa-check-circle' : 'fa-times-circle';
        mysqlDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span class="${statusClass}">
                    <i class="fas ${icon} me-2"></i>${mysqlStatus.status}
                </span>
                <small class="text-muted">
                    ${mysqlStatus.port_accessible ? `Port ${mysqlStatus.port} accessible` : 'Port not accessible'}
                </small>
            </div>
        `;
    }
    
    // PostgreSQL Status
    const postgresDiv = document.getElementById('postgresql-status');
    if (postgresStatus) {
        const statusClass = postgresStatus.running ? 'status-running' : 'status-stopped';
        const icon = postgresStatus.running ? 'fa-check-circle' : 'fa-times-circle';
        postgresDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span class="${statusClass}">
                    <i class="fas ${icon} me-2"></i>${postgresStatus.status}
                </span>
                <small class="text-muted">
                    ${postgresStatus.port_accessible ? `Port ${postgresStatus.port} accessible` : 'Port not accessible'}
                </small>
            </div>
        `;
    }
}

function updateTopServices(services) {
    const servicesDiv = document.getElementById('top-services');
    if (services && services.length > 0) {
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Service</th><th>PID</th><th>CPU%</th><th>Memory%</th></tr></thead><tbody>';
        
        services.slice(0, 5).forEach(service => {
            html += `
                <tr>
                    <td>${service.name}</td>
                    <td>${service.pid}</td>
                    <td>${formatPercentage(service.cpu_percent)}</td>
                    <td>${formatPercentage(service.memory_percent)}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        servicesDiv.innerHTML = html;
    } else {
        servicesDiv.innerHTML = '<p class="text-muted">No services data available</p>';
    }
}

function updateActivePorts(ports) {
    const portsDiv = document.getElementById('active-ports');
    if (ports && ports.length > 0) {
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Port</th><th>Status</th><th>PID</th></tr></thead><tbody>';
        
        ports.slice(0, 5).forEach(port => {
            html += `
                <tr>
                    <td>${port.local_address}</td>
                    <td><span class="badge bg-success">${port.status}</span></td>
                    <td>${port.pid || 'N/A'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        portsDiv.innerHTML = html;
    } else {
        portsDiv.innerHTML = '<p class="text-muted">No ports data available</p>';
    }
}

function updateLastUpdated(timestamp) {
    if (timestamp) {
        const date = new Date(timestamp);
        document.getElementById('last-updated').textContent = date.toLocaleString();
    }
}

// Initial load
refreshData();
</script>
{% endblock %}
