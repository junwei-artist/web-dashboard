{% extends "base.html" %}

{% block title %}PostgreSQL Sync - System Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-database me-2"></i>PostgreSQL Database Sync
            <small class="text-muted">Synchronize PostgreSQL databases</small>
        </h1>
    </div>
</div>

<!-- Tab Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-tabs" id="postgresSyncTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="complete-model-tab" data-bs-toggle="tab" data-bs-target="#complete-model" type="button" role="tab">
                    <i class="fas fa-exchange-alt me-1"></i>Complete Model (Bidirectional)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="one-way-tab" data-bs-toggle="tab" data-bs-target="#one-way" type="button" role="tab">
                    <i class="fas fa-arrow-right me-1"></i>One-Way Sync
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Tab Content -->
<div class="tab-content" id="postgresSyncTabsContent">
    <!-- Complete Model Tab -->
    <div class="tab-pane fade show active" id="complete-model" role="tabpanel">
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-primary" onclick="showAddJobModal('complete_model')" data-requires-edit>
                    <i class="fas fa-plus me-1"></i>Add New Job
                </button>
            </div>
        </div>
        <div id="complete-model-jobs-container">
            <!-- Jobs will be dynamically added here -->
        </div>
    </div>

    <!-- One-Way Sync Tab -->
    <div class="tab-pane fade" id="one-way" role="tabpanel">
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-primary" onclick="showAddJobModal('one_way')" data-requires-edit>
                    <i class="fas fa-plus me-1"></i>Add New Job
                </button>
            </div>
        </div>
        <div id="one-way-jobs-container">
            <!-- Jobs will be dynamically added here -->
        </div>
    </div>
</div>

<!-- Add/Edit Job Modal -->
<div class="modal fade" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobModalLabel">Add PostgreSQL Sync Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="jobForm">
                    <input type="hidden" id="jobId" name="job_id">
                    <input type="hidden" id="syncType" name="sync_type">
                    
                    <div class="mb-3">
                        <label for="jobName" class="form-label">Job Name</label>
                        <input type="text" class="form-control" id="jobName" name="name" required>
                        <small class="form-text text-muted">A descriptive name for this sync job.</small>
                    </div>
                    
                    <hr>
                    <h5>Source Database</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sourceHost" class="form-label">Host/IP <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="sourceHost" name="source_host" placeholder="192.168.1.100" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="sourcePort" class="form-label">Port <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="sourcePort" name="source_port" value="5432" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="sourceDatabase" class="form-label">Database <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="sourceDatabase" name="source_database" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sourceUser" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="sourceUser" name="source_user" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sourcePassword" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="sourcePassword" name="source_password" required>
                        </div>
                    </div>
                    
                    <hr>
                    <h5>Target Database</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="targetHost" class="form-label">Host/IP <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="targetHost" name="target_host" placeholder="192.168.1.101" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="targetPort" class="form-label">Port <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="targetPort" name="target_port" value="5432" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="targetDatabase" class="form-label">Database <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="targetDatabase" name="target_database" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="targetUser" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="targetUser" name="target_user" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="targetPassword" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="targetPassword" name="target_password" required>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="mb-3">
                        <label for="checkInterval" class="form-label">Check Interval (seconds) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="checkInterval" name="check_interval" value="60" min="10" required>
                        <small class="form-text text-muted">How often to automatically sync when running in persistent mode. Minimum: 10 seconds.</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-1"></i>Sync Type Details:</h6>
                        <div id="syncTypeExplanation">
                            <strong>Complete Model:</strong> Bidirectional sync based on row IDs<br>
                            <small>• Compares tables in both databases<br>
                            • Syncs missing rows from source to target<br>
                            • Syncs missing rows from target to source<br>
                            • Only syncs rows based on primary key (ID)<br>
                            • Skips errors in current round, retries next round</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveJob()" data-requires-edit>Save Job</button>
            </div>
        </div>
    </div>
</div>

<!-- Job Monitor Modal -->
<div class="modal fade" id="monitorModal" tabindex="-1" aria-labelledby="monitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="monitorModalLabel">Job Monitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="badge bg-info" id="monitorJobStatus">Status: Unknown</div>
                    <div class="mt-2" id="monitorStats"></div>
                </div>
                <!-- Tabs for Status and Logs -->
                <ul class="nav nav-tabs mb-3" id="monitorTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="status-tab" data-bs-toggle="tab" data-bs-target="#status-pane" type="button" role="tab">
                            <i class="fas fa-table me-1"></i>Sync Status
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-pane" type="button" role="tab">
                            <i class="fas fa-terminal me-1"></i>Real-time Logs
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="monitorTabsContent">
                    <!-- Status Tab -->
                    <div class="tab-pane fade show active" id="status-pane" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Sync Status (Last 20 Rows)</h6>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Table</th>
                                            <th>Row ID</th>
                                            <th>Message</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monitorStatusTable">
                                        <tr>
                                            <td colspan="5" class="text-muted text-center">Waiting for sync data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logs Tab -->
                    <div class="tab-pane fade" id="logs-pane" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Real-time Logs</h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                    <i class="fas fa-trash me-1"></i>Clear
                                </button>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 12px;">
                                <div id="monitorLogs">
                                    <div class="text-muted">Waiting for logs...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.job-card {
    margin-bottom: 20px;
}
.job-status-running {
    color: #28a745;
}
.job-status-stopped {
    color: #6c757d;
}
.job-status-error {
    color: #dc3545;
}
.status-badge-success {
    background-color: #28a745;
    color: white;
}
.status-badge-error {
    background-color: #dc3545;
    color: white;
}
.status-badge-skipped {
    background-color: #ffc107;
    color: black;
}
.monitor-log-line {
    padding: 2px 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    border-bottom: 1px solid #2d2d2d;
}
.monitor-log-line.info {
    color: #d4d4d4;
}
.monitor-log-line.success {
    color: #4ec9b0;
}
.monitor-log-line.error {
    color: #f48771;
}
.monitor-log-line.warning {
    color: #dcdcaa;
}
.monitor-log-line.skipped {
    color: #ce9178;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
let socket;
let currentMonitorJobId = null;
let jobs = {};

// Initialize Socket.IO
document.addEventListener('DOMContentLoaded', function() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Connected to PostgreSQL sync monitor');
    });
    
    socket.on('postgres_job_output', function(data) {
        if (data.job_id === currentMonitorJobId) {
            // Handle different types of output
            if (data.data.type === 'log') {
                addLogLine(data.data);
            } else if (data.data.type === 'status') {
                addMonitorOutput(data.data);
            } else {
                // Legacy format - assume it's a status row
                addMonitorOutput(data.data);
            }
        }
    });
    
    socket.on('subscribed', function(data) {
        console.log('Subscribed to job:', data.job_id);
    });
    
    loadJobs();
    
    // Refresh jobs every 5 seconds
    setInterval(loadJobs, 5000);
});

function loadJobs() {
    fetch('/api/postgres-sync/jobs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                jobs = {};
                data.jobs.forEach(job => {
                    jobs[job.job_id] = job;
                });
                renderJobs();
            }
        })
        .catch(error => {
            console.error('Error loading jobs:', error);
        });
}

function renderJobs() {
    const completeModelContainer = document.getElementById('complete-model-jobs-container');
    const oneWayContainer = document.getElementById('one-way-jobs-container');
    
    completeModelContainer.innerHTML = '';
    oneWayContainer.innerHTML = '';
    
    Object.values(jobs).forEach(job => {
        const container = job.sync_type === 'complete_model' ? completeModelContainer : oneWayContainer;
        const card = createJobCard(job);
        container.appendChild(card);
    });
    
    if (completeModelContainer.children.length === 0) {
        completeModelContainer.innerHTML = '<div class="alert alert-info">No jobs configured. Click "Add New Job" to create one.</div>';
    }
    if (oneWayContainer.children.length === 0) {
        oneWayContainer.innerHTML = '<div class="alert alert-info">No jobs configured. Click "Add New Job" to create one.</div>';
    }
}

function createJobCard(job) {
    const card = document.createElement('div');
    card.className = 'card job-card';
    card.id = `job-${job.job_id}`;
    
    // Determine status display
    let statusBadges = [];
    let statusText = '';
    
    if (job.is_running) {
        statusBadges.push('<span class="badge bg-warning"><i class="fas fa-spinner fa-spin me-1"></i>Task Running</span>');
    }
    
    if (job.is_persistent) {
        statusBadges.push(`<span class="badge bg-info"><i class="fas fa-clock me-1"></i>Auto Persistent (${job.check_interval}s)</span>`);
    }
    
    if (!job.is_running && !job.is_persistent) {
        statusBadges.push('<span class="badge bg-secondary">Stopped</span>');
    }
    
    if (job.status === 'error') {
        statusBadges.push('<span class="badge bg-danger"><i class="fas fa-exclamation-circle me-1"></i>Error</span>');
    }
    
    const statusClass = job.status === 'running' ? 'job-status-running' : 
                       job.status === 'error' ? 'job-status-error' : 'job-status-stopped';
    
    const stats = job.last_sync_stats || {};
    const statsHtml = job.last_sync_stats ? `
        <div class="row mt-2">
            <div class="col-md-3"><small><strong>Tables:</strong> ${stats.tables_processed || 0}</small></div>
            <div class="col-md-3"><small><strong>Synced:</strong> ${stats.rows_synced || stats.rows_synced_source_to_target || 0}</small></div>
            <div class="col-md-3"><small><strong>Failed:</strong> ${stats.rows_failed || 0}</small></div>
            <div class="col-md-3"><small><strong>Skipped:</strong> ${stats.rows_skipped || 0}</small></div>
        </div>
    ` : '';
    
    card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">${escapeHtml(job.name)}</h5>
                <div class="mt-1">
                    ${statusBadges.join(' ')}
                    ${job.last_run ? `<small class="text-muted ms-2">Last run: ${new Date(job.last_run).toLocaleString()}</small>` : ''}
                </div>
                ${statsHtml}
            </div>
            <div>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editJob('${job.job_id}')" title="Edit" data-requires-edit>
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteJob('${job.job_id}')" title="Delete" data-requires-edit>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-md-6">
                    <strong>Source:</strong> ${escapeHtml(job.source_user)}@${escapeHtml(job.source_host)}:${escapeHtml(job.source_port)}/${escapeHtml(job.source_database)}
                </div>
                <div class="col-md-6">
                    <strong>Target:</strong> ${escapeHtml(job.target_user)}@${escapeHtml(job.target_host)}:${escapeHtml(job.target_port)}/${escapeHtml(job.target_database)}
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-md-6">
                    <strong>Sync Type:</strong> ${job.sync_type === 'complete_model' ? 'Complete Model (Bidirectional)' : 'One-Way (Source to Target)'}
                </div>
                <div class="col-md-6">
                    <strong>Check Interval:</strong> ${job.check_interval} seconds
                </div>
            </div>
            <div class="mt-3">
                ${job.is_running ? 
                    `<button class="btn btn-sm btn-warning me-2" onclick="stopJob('${job.job_id}')" data-requires-edit>
                        <i class="fas fa-stop me-1"></i>Stop Task
                    </button>` : ''
                }
                ${job.is_persistent ? 
                    `<button class="btn btn-sm btn-danger me-2" onclick="stopPersistent('${job.job_id}')" data-requires-edit>
                        <i class="fas fa-pause me-1"></i>Stop Auto Persistent
                    </button>` :
                    `<button class="btn btn-sm btn-success me-2" onclick="startJob('${job.job_id}', true)" data-requires-edit>
                        <i class="fas fa-play me-1"></i>Start Auto Persistent
                    </button>`
                }
                ${!job.is_running ? 
                    `<button class="btn btn-sm btn-primary me-2" onclick="runJobOnce('${job.job_id}')" data-requires-edit>
                        <i class="fas fa-sync me-1"></i>Run Once
                    </button>` : ''
                }
                <button class="btn btn-sm btn-info" onclick="showMonitor('${job.job_id}')">
                    <i class="fas fa-tv me-1"></i>Monitor
                </button>
            </div>
        </div>
    `;
    
    return card;
}

function showAddJobModal(syncType) {
    document.getElementById('jobId').value = '';
    document.getElementById('jobName').value = '';
    document.getElementById('sourceHost').value = '';
    document.getElementById('sourcePort').value = '5432';
    document.getElementById('sourceDatabase').value = '';
    document.getElementById('sourceUser').value = '';
    document.getElementById('sourcePassword').value = '';
    document.getElementById('sourcePassword').placeholder = '';
    document.getElementById('targetHost').value = '';
    document.getElementById('targetPort').value = '5432';
    document.getElementById('targetDatabase').value = '';
    document.getElementById('targetUser').value = '';
    document.getElementById('targetPassword').value = '';
    document.getElementById('targetPassword').placeholder = '';
    document.getElementById('checkInterval').value = '60';
    document.getElementById('syncType').value = syncType === 'complete_model' ? 'complete_model' : 'one_way';
    document.getElementById('jobModalLabel').textContent = syncType === 'complete_model' ? 'Add Job - Complete Model (Bidirectional)' : 'Add Job - One-Way Sync';
    
    // Update sync type explanation
    const explanationDiv = document.getElementById('syncTypeExplanation');
    if (syncType === 'complete_model') {
        explanationDiv.innerHTML = `
            <strong>Complete Model:</strong> Bidirectional sync based on row IDs<br>
            <small>• Compares tables in both databases<br>
            • Syncs missing rows from source to target<br>
            • Syncs missing rows from target to source<br>
            • Only syncs rows based on primary key (ID)<br>
            • Skips errors in current round, retries next round</small>
        `;
    } else {
        explanationDiv.innerHTML = `
            <strong>One-Way Sync:</strong> Source to Target only<br>
            <small>• Compares tables in both databases<br>
            • Only syncs missing rows from source to target<br>
            • Only syncs rows based on primary key (ID)<br>
            • Skips errors in current round, retries next round</small>
        `;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('jobModal'));
    modal.show();
}

function editJob(jobId) {
    const job = jobs[jobId];
    if (!job) {
        alert('Job not found');
        return;
    }
    
    // Warn if job is running
    if (job.is_running) {
        if (!confirm('This job is currently running. Changes will take effect after the current sync completes or when you restart the job. Continue editing?')) {
            return;
        }
    }
    
    // Populate form fields with job data
    document.getElementById('jobId').value = job.job_id;
    document.getElementById('jobName').value = job.name;
    document.getElementById('sourceHost').value = job.source_host;
    document.getElementById('sourcePort').value = job.source_port;
    document.getElementById('sourceDatabase').value = job.source_database;
    document.getElementById('sourceUser').value = job.source_user;
    // Password is masked, leave empty so user can enter new one or keep existing
    document.getElementById('sourcePassword').value = '';
    document.getElementById('sourcePassword').placeholder = 'Leave empty to keep current password';
    document.getElementById('targetHost').value = job.target_host;
    document.getElementById('targetPort').value = job.target_port;
    document.getElementById('targetDatabase').value = job.target_database;
    document.getElementById('targetUser').value = job.target_user;
    // Password is masked, leave empty so user can enter new one or keep existing
    document.getElementById('targetPassword').value = '';
    document.getElementById('targetPassword').placeholder = 'Leave empty to keep current password';
    document.getElementById('checkInterval').value = job.check_interval;
    document.getElementById('syncType').value = job.sync_type;
    document.getElementById('jobModalLabel').textContent = job.sync_type === 'complete_model' ? 'Edit Job - Complete Model (Bidirectional)' : 'Edit Job - One-Way Sync';
    
    // Update sync type explanation
    const explanationDiv = document.getElementById('syncTypeExplanation');
    if (job.sync_type === 'complete_model') {
        explanationDiv.innerHTML = `
            <strong>Complete Model:</strong> Bidirectional sync based on row IDs<br>
            <small>• Compares tables in both databases<br>
            • Syncs missing rows from source to target<br>
            • Syncs missing rows from target to source<br>
            • Only syncs rows based on primary key (ID)<br>
            • Skips errors in current round, retries next round</small>
        `;
    } else {
        explanationDiv.innerHTML = `
            <strong>One-Way Sync:</strong> Source to Target only<br>
            <small>• Compares tables in both databases<br>
            • Only syncs missing rows from source to target<br>
            • Only syncs rows based on primary key (ID)<br>
            • Skips errors in current round, retries next round</small>
        `;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('jobModal'));
    modal.show();
}

function saveJob() {
    const form = document.getElementById('jobForm');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
        // Only include password fields if they have a value (to allow keeping existing password)
        if (key === 'source_password' || key === 'target_password') {
            if (value && value.trim() !== '') {
                data[key] = value;
            }
        } else {
            data[key] = value;
        }
    });
    
    const jobId = document.getElementById('jobId').value;
    const url = jobId ? `/api/postgres-sync/jobs/${jobId}` : '/api/postgres-sync/jobs';
    const method = jobId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('jobModal')).hide();
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to save job'));
        }
    })
    .catch(error => {
        console.error('Error saving job:', error);
        alert('Error saving job: ' + error.message);
    });
}

function deleteJob(jobId) {
    if (!confirm('Are you sure you want to delete this job?')) {
        return;
    }
    
    fetch(`/api/postgres-sync/jobs/${jobId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete job'));
        }
    })
    .catch(error => {
        console.error('Error deleting job:', error);
        alert('Error deleting job: ' + error.message);
    });
}

function startJob(jobId, persistent) {
    fetch(`/api/postgres-sync/jobs/${jobId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ persistent: persistent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to start job'));
        }
    })
    .catch(error => {
        console.error('Error starting job:', error);
        alert('Error starting job: ' + error.message);
    });
}

function stopJob(jobId) {
    fetch(`/api/postgres-sync/jobs/${jobId}/stop-task`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to stop task'));
        }
    })
    .catch(error => {
        console.error('Error stopping task:', error);
        alert('Error stopping task: ' + error.message);
    });
}

function stopPersistent(jobId) {
    fetch(`/api/postgres-sync/jobs/${jobId}/stop-persistent`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to stop persistent mode'));
        }
    })
    .catch(error => {
        console.error('Error stopping persistent mode:', error);
        alert('Error stopping persistent mode: ' + error.message);
    });
}

function runJobOnce(jobId) {
    fetch(`/api/postgres-sync/jobs/${jobId}/run-once`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to run job'));
        }
    })
    .catch(error => {
        console.error('Error running job:', error);
        alert('Error running job: ' + error.message);
    });
}

function showMonitor(jobId) {
    currentMonitorJobId = jobId;
    const job = jobs[jobId];
    
    document.getElementById('monitorJobStatus').textContent = `Status: ${job.status}`;
    
    // Show stats
    const stats = job.last_sync_stats || {};
    let statsHtml = '';
    if (Object.keys(stats).length > 0) {
        statsHtml = `
            <div class="row mt-2">
                <div class="col-md-3"><strong>Tables Processed:</strong> ${stats.tables_processed || 0}</div>
                <div class="col-md-3"><strong>Rows Synced:</strong> ${stats.rows_synced || stats.rows_synced_source_to_target || 0}</div>
                <div class="col-md-3"><strong>Rows Failed:</strong> ${stats.rows_failed || 0}</div>
                <div class="col-md-3"><strong>Rows Skipped:</strong> ${stats.rows_skipped || 0}</div>
            </div>
        `;
    }
    document.getElementById('monitorStats').innerHTML = statsHtml;
    
    // Clear and load existing monitor rows
    const statusTable = document.getElementById('monitorStatusTable');
    statusTable.innerHTML = '<tr><td colspan="5" class="text-muted text-center">Loading...</td></tr>';
    
    // Clear logs
    document.getElementById('monitorLogs').innerHTML = '<div class="text-muted">Waiting for logs...</div>';
    
    // Subscribe to job output
    socket.emit('subscribe_postgres_job', { job_id: jobId });
    
    // Load existing logs
    fetch(`/api/postgres-sync/jobs/${jobId}/logs`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderMonitorRows(data.logs.monitor_rows || []);
            }
        })
        .catch(error => {
            console.error('Error loading logs:', error);
            statusTable.innerHTML = '<tr><td colspan="5" class="text-danger text-center">Error loading logs</td></tr>';
        });
    
    const modal = new bootstrap.Modal(document.getElementById('monitorModal'));
    modal.show();
    
    // Unsubscribe when modal is closed
    document.getElementById('monitorModal').addEventListener('hidden.bs.modal', function() {
        socket.emit('unsubscribe_postgres_job', { job_id: jobId });
        currentMonitorJobId = null;
    }, { once: true });
}

function renderMonitorRows(rows) {
    const tbody = document.getElementById('monitorStatusTable');
    
    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">No sync activity yet</td></tr>';
        return;
    }
    
    tbody.innerHTML = '';
    rows.forEach(row => {
        const tr = document.createElement('tr');
        const timestamp = new Date(row.timestamp).toLocaleString();
        const statusBadge = row.status === 'success' ? 'status-badge-success' : 
                           row.status === 'error' ? 'status-badge-error' : 'status-badge-skipped';
        const statusText = row.status === 'success' ? 'Success' : 
                          row.status === 'error' ? 'Error' : 'Skipped';
        
        tr.innerHTML = `
            <td>${timestamp}</td>
            <td><span class="badge ${statusBadge}">${statusText}</span></td>
            <td>${escapeHtml(row.table_name || 'N/A')}</td>
            <td>${escapeHtml(row.row_id || 'N/A')}</td>
            <td>${escapeHtml(row.message || '')}</td>
        `;
        tbody.appendChild(tr);
    });
}

function addLogLine(data) {
    const logsDiv = document.getElementById('monitorLogs');
    
    // Remove "Waiting for logs..." message if present
    if (logsDiv.children.length === 1 && logsDiv.children[0].classList.contains('text-muted')) {
        logsDiv.innerHTML = '';
    }
    
    const line = document.createElement('div');
    line.className = `monitor-log-line ${data.level || 'info'}`;
    
    const timestamp = new Date(data.timestamp).toLocaleTimeString();
    line.textContent = `[${timestamp}] ${data.message}`;
    
    logsDiv.appendChild(line);
    
    // Keep only last 30 lines
    while (logsDiv.children.length > 30) {
        logsDiv.removeChild(logsDiv.firstChild);
    }
    
    // Auto-scroll to bottom
    logsDiv.scrollTop = logsDiv.scrollHeight;
}

function clearLogs() {
    document.getElementById('monitorLogs').innerHTML = '<div class="text-muted">Logs cleared...</div>';
}

function addMonitorOutput(data) {
    // Update the status table with latest rows
    const rows = jobs[currentMonitorJobId]?.monitor_rows || [];
    renderMonitorRows(rows);
    
    // Update status if available
    if (jobs[currentMonitorJobId]) {
        document.getElementById('monitorJobStatus').textContent = `Status: ${jobs[currentMonitorJobId].status}`;
        
        // Update stats
        const stats = jobs[currentMonitorJobId].last_sync_stats || {};
        if (Object.keys(stats).length > 0) {
            const statsHtml = `
                <div class="row mt-2">
                    <div class="col-md-3"><strong>Tables Processed:</strong> ${stats.tables_processed || 0}</div>
                    <div class="col-md-3"><strong>Rows Synced:</strong> ${stats.rows_synced || stats.rows_synced_source_to_target || 0}</div>
                    <div class="col-md-3"><strong>Rows Failed:</strong> ${stats.rows_failed || 0}</div>
                    <div class="col-md-3"><strong>Rows Skipped:</strong> ${stats.rows_skipped || 0}</div>
                </div>
            `;
            document.getElementById('monitorStats').innerHTML = statsHtml;
        }
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

