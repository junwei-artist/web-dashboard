{% extends "base.html" %}

{% block title %}Ports - System Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-network-wired me-2"></i>Active Ports
            <small class="text-muted">Monitor network connections and listening ports</small>
        </h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="port-search" placeholder="Search ports...">
        </div>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-outline-primary" onclick="refreshPorts()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Active Ports List
            <span class="badge bg-primary ms-2" id="port-count">0</span>
        </h5>
    </div>
    <div class="card-body">
        <div id="ports-container">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Loading ports...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allPorts = [];

function refreshPorts() {
    showLoading('ports-container');
    
    fetch('/api/ports')
        .then(response => response.json())
        .then(ports => {
            allPorts = ports;
            displayPorts(ports);
            document.getElementById('port-count').textContent = ports.length;
        })
        .catch(error => {
            console.error('Error fetching ports:', error);
            showError('ports-container', 'Failed to load ports data');
        });
}

function displayPorts(ports) {
    const container = document.getElementById('ports-container');
    
    if (!ports || ports.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No active ports found</p>';
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th onclick="sortPorts('local_address')" style="cursor: pointer;">
                            Local Address <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortPorts('port_label')" style="cursor: pointer;">
                            Service <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortPorts('process_name')" style="cursor: pointer;">
                            Process <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortPorts('status')" style="cursor: pointer;">
                            Status <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortPorts('pid')" style="cursor: pointer;">
                            PID <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortPorts('family')" style="cursor: pointer;">
                            Family <i class="fas fa-sort"></i>
                        </th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    ports.forEach(port => {
        const statusClass = port.status === 'LISTEN' ? 'success' : 'info';
        const portLabel = port.port_label || 'Unknown Service';
        const processName = port.process_name || 'N/A';
        
        // Determine badge color based on service type
        let labelClass = 'bg-secondary'; // default
        if (portLabel.includes('MySQL') || portLabel.includes('PostgreSQL') || portLabel.includes('Redis') || portLabel.includes('MongoDB')) {
            labelClass = 'bg-primary'; // database
        } else if (portLabel.includes('HTTP') || portLabel.includes('HTTPS') || portLabel.includes('Node.js') || portLabel.includes('Python') || portLabel.includes('Flask')) {
            labelClass = 'bg-success'; // web server
        } else if (portLabel.includes('Development') || portLabel.includes('Dev')) {
            labelClass = 'bg-warning'; // development
        } else if (portLabel.includes('Proxy') || portLabel.includes('VPN')) {
            labelClass = 'bg-info'; // proxy/vpn
        }
        
        html += `
            <tr>
                <td>
                    <code>${port.local_address}</code>
                </td>
                <td>
                    <span class="badge ${labelClass}">${portLabel}</span>
                </td>
                <td>
                    <code>${processName}</code>
                </td>
                <td>
                    <span class="badge bg-${statusClass}">${port.status}</span>
                </td>
                <td>
                    <code>${port.pid || 'N/A'}</code>
                </td>
                <td>
                    <span class="badge bg-secondary">${port.family}</span>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function sortPorts(column) {
    allPorts.sort((a, b) => {
        if (column === 'local_address' || column === 'remote_address') {
            return a[column].localeCompare(b[column]);
        } else if (column === 'pid') {
            return (a.pid || 0) - (b.pid || 0);
        } else {
            return a[column].localeCompare(b[column]);
        }
    });
    displayPorts(allPorts);
}

function filterPorts() {
    const searchTerm = document.getElementById('port-search').value.toLowerCase();
    const filteredPorts = allPorts.filter(port => 
        port.local_address.toLowerCase().includes(searchTerm) ||
        port.remote_address.toLowerCase().includes(searchTerm) ||
        port.status.toLowerCase().includes(searchTerm) ||
        (port.pid && port.pid.toString().includes(searchTerm)) ||
        (port.port_label && port.port_label.toLowerCase().includes(searchTerm)) ||
        (port.process_name && port.process_name.toLowerCase().includes(searchTerm))
    );
    displayPorts(filteredPorts);
    document.getElementById('port-count').textContent = filteredPorts.length;
}

function isCommonPortNumber(port) {
    const commonPorts = ['22', '23', '25', '53', '80', '110', '143', '443', '993', '995', '3306', '5432', '6379', '27017'];
    return commonPorts.includes(port);
}

function getPortService(port) {
    const portServices = {
        '22': 'SSH',
        '23': 'Telnet',
        '25': 'SMTP',
        '53': 'DNS',
        '80': 'HTTP',
        '110': 'POP3',
        '143': 'IMAP',
        '443': 'HTTPS',
        '993': 'IMAPS',
        '995': 'POP3S',
        '3306': 'MySQL',
        '5432': 'PostgreSQL',
        '6379': 'Redis',
        '27017': 'MongoDB'
    };
    return portServices[port] || 'Unknown';
}

// Event listeners
document.getElementById('port-search').addEventListener('input', filterPorts);

// Initial load
refreshPorts();
</script>
{% endblock %}
