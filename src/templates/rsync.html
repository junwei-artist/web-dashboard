{% extends "base.html" %}

{% block title %}Rsync - System Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-sync-alt me-2"></i>Rsync Manager
            <small class="text-muted">Manage file synchronization tasks</small>
        </h1>
    </div>
</div>

<!-- Tab Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-tabs" id="rsyncTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="new-files-tab" data-bs-toggle="tab" data-bs-target="#new-files" type="button" role="tab">
                    <i class="fas fa-upload me-1"></i>Upload New Files Only
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="missing-files-tab" data-bs-toggle="tab" data-bs-target="#missing-files" type="button" role="tab">
                    <i class="fas fa-file-upload me-1"></i>Upload Missing Files
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Tab Content -->
<div class="tab-content" id="rsyncTabsContent">
    <!-- Upload New Files Only Tab -->
    <div class="tab-pane fade show active" id="new-files" role="tabpanel">
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-primary" onclick="showAddJobModal('new_files_only')" data-requires-edit>
                    <i class="fas fa-plus me-1"></i>Add New Job
                </button>
            </div>
        </div>
        <div id="new-files-jobs-container">
            <!-- Jobs will be dynamically added here -->
        </div>
    </div>

    <!-- Upload Missing Files Tab -->
    <div class="tab-pane fade" id="missing-files" role="tabpanel">
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-primary" onclick="showAddJobModal('missing_files')" data-requires-edit>
                    <i class="fas fa-plus me-1"></i>Add New Job
                </button>
            </div>
        </div>
        <div id="missing-files-jobs-container">
            <!-- Jobs will be dynamically added here -->
        </div>
    </div>
</div>

<!-- Add/Edit Job Modal -->
<div class="modal fade" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobModalLabel">Add Rsync Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="jobForm">
                    <input type="hidden" id="jobId" name="job_id">
                    <input type="hidden" id="syncType" name="sync_type">
                    
                    <div class="mb-3">
                        <label for="jobName" class="form-label">Job Name</label>
                        <input type="text" class="form-control" id="jobName" name="name" required>
                        <small class="form-text text-muted">A descriptive name for this rsync job to help identify it.</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="destinationIp" class="form-label">Destination IP <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="destinationIp" name="destination_ip" placeholder="10.3.20.26" required>
                            <small class="form-text text-muted">The IP address of the remote server where files will be synced.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="destinationFolder" class="form-label">Destination Folder <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="destinationFolder" name="destination_folder" placeholder="/opt/homebrew/var/www/files/auto_jmp_files/" required>
                            <small class="form-text text-muted">The full path on the remote server where files will be copied.</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" name="username" placeholder="lstech" required>
                            <small class="form-text text-muted">SSH username for authentication on the remote server.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" placeholder="password">
                            <small class="form-text text-muted">SSH password (optional). If not provided, SSH key authentication will be used. Requires sshpass if password is used.</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sourceFolder" class="form-label">Source Folder <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="sourceFolder" name="source_folder" placeholder="/opt/homebrew/var/www/files/auto_jmp_files/" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="browseSourceFolder()">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                        <small class="form-text text-muted">The local folder path containing files to be synced. Note: File browser is not available. Please enter the path manually.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="updateInterval" class="form-label">Update Interval (seconds) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="updateInterval" name="update_interval" value="60" min="10" required>
                        <small class="form-text text-muted">How often to automatically sync when running in persistent mode. Minimum: 10 seconds. Only applies when "Start Persistent" is used.</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-1"></i>Sync Type Details:</h6>
                        <div id="syncTypeExplanation">
                            <strong>Upload New Files Only:</strong> Uses <code>rsync -avz --update --progress</code><br>
                            <small>• <code>-a</code>: Archive mode (preserves permissions, timestamps, etc.)<br>
                            • <code>-v</code>: Verbose output<br>
                            • <code>-z</code>: Compress data during transfer<br>
                            • <code>--update</code>: Skip files that are newer on the receiver<br>
                            • <code>--progress</code>: Show progress during transfer</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveJob()" data-requires-edit>Save Job</button>
            </div>
        </div>
    </div>
</div>

<!-- Job Monitor Modal -->
<div class="modal fade" id="monitorModal" tabindex="-1" aria-labelledby="monitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="monitorModalLabel">Job Monitor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="badge bg-info" id="monitorJobStatus">Status: Unknown</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Real-time Output</h6>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 12px;">
                        <div id="monitorOutput">
                            <div class="text-muted">Waiting for output...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.job-card {
    margin-bottom: 20px;
}
.job-status-running {
    color: #28a745;
}
.job-status-waiting {
    color: #ffc107;
}
.job-status-stopped {
    color: #6c757d;
}
.job-status-error {
    color: #dc3545;
}
.monitor-output-line {
    padding: 2px 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}
.monitor-output-line.error {
    color: #f48771;
}
.monitor-output-line.output {
    color: #d4d4d4;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
let socket;
let currentMonitorJobId = null;
let jobs = {};

// Initialize Socket.IO
document.addEventListener('DOMContentLoaded', function() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Connected to rsync monitor');
    });
    
    socket.on('job_output', function(data) {
        if (data.job_id === currentMonitorJobId) {
            addMonitorOutput(data.data);
        }
    });
    
    socket.on('subscribed', function(data) {
        console.log('Subscribed to job:', data.job_id);
    });
    
    loadJobs();
    
    // Refresh jobs every 5 seconds
    setInterval(loadJobs, 5000);
});

function loadJobs() {
    fetch('/api/rsync/jobs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                jobs = {};
                data.jobs.forEach(job => {
                    jobs[job.job_id] = job;
                });
                renderJobs();
            }
        })
        .catch(error => {
            console.error('Error loading jobs:', error);
        });
}

function renderJobs() {
    const newFilesContainer = document.getElementById('new-files-jobs-container');
    const missingFilesContainer = document.getElementById('missing-files-jobs-container');
    
    newFilesContainer.innerHTML = '';
    missingFilesContainer.innerHTML = '';
    
    Object.values(jobs).forEach(job => {
        const container = job.sync_type === 'new_files_only' ? newFilesContainer : missingFilesContainer;
        const card = createJobCard(job);
        container.appendChild(card);
        // Load command after card is added to DOM
        setTimeout(() => {
            loadJobCommand(job.job_id);
        }, 100);
    });
    
    if (newFilesContainer.children.length === 0) {
        newFilesContainer.innerHTML = '<div class="alert alert-info">No jobs configured. Click "Add New Job" to create one.</div>';
    }
    if (missingFilesContainer.children.length === 0) {
        missingFilesContainer.innerHTML = '<div class="alert alert-info">No jobs configured. Click "Add New Job" to create one.</div>';
    }
}

function createJobCard(job) {
    const card = document.createElement('div');
    card.className = 'card job-card';
    card.id = `job-${job.job_id}`;
    
    const statusClass = job.status === 'running' ? 'job-status-running' : 
                       job.status === 'waiting' ? 'job-status-warning' :
                       job.status === 'error' ? 'job-status-error' : 'job-status-stopped';
    const statusIcon = job.status === 'running' ? 'fa-spinner fa-spin' : 
                      job.status === 'waiting' ? 'fa-clock' :
                      job.status === 'error' ? 'fa-exclamation-circle' : 'fa-stop-circle';
    
    card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">${escapeHtml(job.name)}</h5>
                <small class="text-muted">
                    <i class="fas ${statusIcon} ${statusClass} me-1"></i>
                    <span class="${statusClass}">${job.status === 'waiting' ? 'Waiting for next run' : job.status}</span>
                    ${job.last_run ? ` | Last run: ${new Date(job.last_run).toLocaleString()}` : ''}
                </small>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editJob('${job.job_id}')" title="Edit" data-requires-edit>
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteJob('${job.job_id}')" title="Delete" data-requires-edit>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-md-6">
                    <strong>Source:</strong> ${escapeHtml(job.source_folder)}
                </div>
                <div class="col-md-6">
                    <strong>Destination:</strong> ${escapeHtml(job.username)}@${escapeHtml(job.destination_ip)}:${escapeHtml(job.destination_folder)}
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-md-6">
                    <strong>Update Interval:</strong> ${job.update_interval} seconds
                </div>
                <div class="col-md-6">
                    <strong>Type:</strong> ${job.sync_type === 'new_files_only' ? 'Upload New Files Only' : 'Upload Missing Files'}
                </div>
            </div>
            <div class="mb-3">
                <strong>Rsync Command:</strong>
                <div class="mt-2 p-2 bg-dark text-light rounded" style="font-family: monospace; font-size: 12px; max-height: 150px; overflow-y: auto; white-space: pre-wrap;">
                    <div id="command-${job.job_id}">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            <div class="mt-3">
                ${job.is_running ? 
                    `<button class="btn btn-sm btn-warning me-2" onclick="stopJob('${job.job_id}')" data-requires-edit>
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>` :
                    `<button class="btn btn-sm btn-success me-2" onclick="startJob('${job.job_id}', true)" data-requires-edit>
                        <i class="fas fa-play me-1"></i>Start Persistent
                    </button>
                    <button class="btn btn-sm btn-primary me-2" onclick="runJobOnce('${job.job_id}')" data-requires-edit>
                        <i class="fas fa-sync me-1"></i>Run Once
                    </button>`
                }
                <button class="btn btn-sm btn-info" onclick="showMonitor('${job.job_id}')">
                    <i class="fas fa-tv me-1"></i>Monitor
                </button>
            </div>
        </div>
    `;
    
    return card;
}

function showAddJobModal(syncType) {
    document.getElementById('jobId').value = '';
    document.getElementById('jobName').value = '';
    document.getElementById('destinationIp').value = '';
    document.getElementById('destinationFolder').value = '';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('sourceFolder').value = '';
    document.getElementById('updateInterval').value = '60';
    document.getElementById('syncType').value = syncType === 'new_files_only' ? 'new_files_only' : 'missing_files';
    document.getElementById('jobModalLabel').textContent = syncType === 'new_files_only' ? 'Add Job - Upload New Files Only' : 'Add Job - Upload Missing Files';
    
    // Update sync type explanation
    updateSyncTypeExplanation(syncType);
    
    const modal = new bootstrap.Modal(document.getElementById('jobModal'));
    modal.show();
}

function editJob(jobId) {
    const job = jobs[jobId];
    if (!job) {
        alert('Job not found');
        return;
    }
    
    // Stop the job if it's running before editing
    if (job.is_running) {
        if (!confirm('This job is currently running. It will be stopped to allow editing. Continue?')) {
            return;
        }
        stopJob(jobId);
    }
    
    // Populate form with job data
    document.getElementById('jobId').value = job.job_id;
    document.getElementById('jobName').value = job.name || '';
    document.getElementById('destinationIp').value = job.destination_ip || '';
    document.getElementById('destinationFolder').value = job.destination_folder || '';
    document.getElementById('username').value = job.username || '';
    // Don't populate password for security (user needs to re-enter if changing)
    document.getElementById('password').value = '';
    document.getElementById('sourceFolder').value = job.source_folder || '';
    document.getElementById('updateInterval').value = job.update_interval || '60';
    document.getElementById('syncType').value = job.sync_type || 'new_files_only';
    
    // Update modal title
    const syncTypeName = job.sync_type === 'new_files_only' ? 'Upload New Files Only' : 'Upload Missing Files';
    document.getElementById('jobModalLabel').textContent = `Edit Job - ${syncTypeName}`;
    
    // Update sync type explanation
    updateSyncTypeExplanation(job.sync_type);
    
    const modal = new bootstrap.Modal(document.getElementById('jobModal'));
    modal.show();
}

function updateSyncTypeExplanation(syncType) {
    const explanationDiv = document.getElementById('syncTypeExplanation');
    if (syncType === 'new_files_only') {
        explanationDiv.innerHTML = `
            <strong>Upload New Files Only:</strong> Uses <code>rsync -avz --update --progress</code><br>
            <small>• <code>-a</code>: Archive mode (preserves permissions, timestamps, etc.)<br>
            • <code>-v</code>: Verbose output<br>
            • <code>-z</code>: Compress data during transfer<br>
            • <code>--update</code>: Skip files that are newer on the receiver<br>
            • <code>--progress</code>: Show progress during transfer</small>
        `;
    } else {
        explanationDiv.innerHTML = `
            <strong>Upload Missing Files:</strong> Uses <code>rsync -avz --ignore-existing --progress</code><br>
            <small>• <code>-a</code>: Archive mode (preserves permissions, timestamps, etc.)<br>
            • <code>-v</code>: Verbose output<br>
            • <code>-z</code>: Compress data during transfer<br>
            • <code>--ignore-existing</code>: Skip files that already exist on the receiver<br>
            • <code>--progress</code>: Show progress during transfer</small>
        `;
    }
}

function loadJobCommand(jobId) {
    fetch(`/api/rsync/jobs/${jobId}/command`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const commandDiv = document.getElementById(`command-${jobId}`);
                if (commandDiv) {
                    commandDiv.textContent = data.command;
                }
            } else {
                const commandDiv = document.getElementById(`command-${jobId}`);
                if (commandDiv) {
                    commandDiv.innerHTML = '<span class="text-danger">Error loading command</span>';
                }
            }
        })
        .catch(error => {
            console.error('Error loading command:', error);
            const commandDiv = document.getElementById(`command-${jobId}`);
            if (commandDiv) {
                commandDiv.innerHTML = '<span class="text-danger">Error loading command</span>';
            }
        });
}

function saveJob() {
    const form = document.getElementById('jobForm');
    const formData = new FormData(form);
    const data = {};
    const jobId = document.getElementById('jobId').value;
    const isEdit = jobId && jobId.trim() !== '';
    
    formData.forEach((value, key) => {
        // Skip empty password fields when editing (don't update password if not provided)
        if (key === 'password' && isEdit && !value) {
            return;
        }
        data[key] = value;
    });
    
    const url = isEdit ? `/api/rsync/jobs/${jobId}` : '/api/rsync/jobs';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('jobModal')).hide();
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to save job'));
        }
    })
    .catch(error => {
        console.error('Error saving job:', error);
        alert('Error saving job: ' + error.message);
    });
}

function deleteJob(jobId) {
    if (!confirm('Are you sure you want to delete this job?')) {
        return;
    }
    
    fetch(`/api/rsync/jobs/${jobId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete job'));
        }
    })
    .catch(error => {
        console.error('Error deleting job:', error);
        alert('Error deleting job: ' + error.message);
    });
}

function startJob(jobId, persistent) {
    fetch(`/api/rsync/jobs/${jobId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ persistent: persistent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to start job'));
        }
    })
    .catch(error => {
        console.error('Error starting job:', error);
        alert('Error starting job: ' + error.message);
    });
}

function stopJob(jobId) {
    fetch(`/api/rsync/jobs/${jobId}/stop`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to stop job'));
        }
    })
    .catch(error => {
        console.error('Error stopping job:', error);
        alert('Error stopping job: ' + error.message);
    });
}

function runJobOnce(jobId) {
    fetch(`/api/rsync/jobs/${jobId}/run-once`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to run job'));
        }
    })
    .catch(error => {
        console.error('Error running job:', error);
        alert('Error running job: ' + error.message);
    });
}

function showMonitor(jobId) {
    currentMonitorJobId = jobId;
    const job = jobs[jobId];
    
    document.getElementById('monitorJobStatus').textContent = `Status: ${job.status}`;
    document.getElementById('monitorOutput').innerHTML = '<div class="text-muted">Waiting for output...</div>';
    
    // Subscribe to job output
    socket.emit('subscribe_job', { job_id: jobId });
    
    // Load existing logs (only last 20)
    fetch(`/api/rsync/jobs/${jobId}/logs?limit=20`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const outputDiv = document.getElementById('monitorOutput');
                outputDiv.innerHTML = '';
                
                // Combine and sort logs by timestamp
                const allLogs = [
                    ...data.logs.output.map(log => ({ ...log, type: 'output' })),
                    ...data.logs.error.map(log => ({ ...log, type: 'error' }))
                ].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // Only show the last 20 logs
                const last20Logs = allLogs.slice(-20);
                
                last20Logs.forEach(log => {
                    addMonitorOutput(log);
                });
            }
        })
        .catch(error => {
            console.error('Error loading logs:', error);
        });
    
    const modal = new bootstrap.Modal(document.getElementById('monitorModal'));
    modal.show();
    
    // Unsubscribe when modal is closed
    document.getElementById('monitorModal').addEventListener('hidden.bs.modal', function() {
        socket.emit('unsubscribe_job', { job_id: jobId });
        currentMonitorJobId = null;
    }, { once: true });
}

function addMonitorOutput(data) {
    const outputDiv = document.getElementById('monitorOutput');
    const line = document.createElement('div');
    line.className = `monitor-output-line ${data.type}`;
    
    const timestamp = new Date(data.timestamp).toLocaleTimeString();
    line.textContent = `[${timestamp}] ${data.message}`;
    
    outputDiv.appendChild(line);
    
    // Keep only the last 20 lines
    const lines = outputDiv.querySelectorAll('.monitor-output-line');
    if (lines.length > 20) {
        // Remove the oldest lines (first ones)
        const linesToRemove = lines.length - 20;
        for (let i = 0; i < linesToRemove; i++) {
            lines[i].remove();
        }
    }
    
    outputDiv.scrollTop = outputDiv.scrollHeight;
    
    // Update status if available
    if (jobs[currentMonitorJobId]) {
        document.getElementById('monitorJobStatus').textContent = `Status: ${jobs[currentMonitorJobId].status}`;
    }
}

function browseSourceFolder() {
    alert('File browser is not available. Please enter the source folder path manually.');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

